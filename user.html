<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pengaturan • BIG Motor</title>

<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600&display=swap" rel="stylesheet">

<script>
/* ======= Konfigurasi ======= */
const API_BASE = "https://api.bigmotor.biz.id";
const CLOUDINARY_UPLOAD = "https://api.cloudinary.com/v1_1/djifuridf/image/upload";
const CLOUDINARY_PRESET = "bmt_upload";
const $ = id => document.getElementById(id);

/* ======= Bounce navigation ======= */
function bounceThenNavigate(el,url){
  if(el){
    el.classList.add("bounce");
    setTimeout(()=>el.classList.remove("bounce"),280);
  }
  setTimeout(()=> guardedNavigate(url),90);
}
function guardedNavigate(url){ window.location = url; }

/* ======= Init ======= */
document.addEventListener("DOMContentLoaded", ()=>{
  loadUsers();
  const np = document.getElementById("navPengaturan");
  if(np) np.classList.add("nav-active");
});
</script>

<style>
:root{--card:#fff}
body{
  margin:0;
  padding-bottom:92px;
  background:#f4f5f7;
  font-family:Inter,Segoe UI,Roboto,Arial;
  color:#222;
}
*{ -webkit-tap-highlight-color:transparent }

/* info card */
.info-card{
  background:var(--card);
  margin:16px;
  padding:14px;
  border-radius:12px;
  box-shadow:0 3px 10px rgba(0,0,0,0.10);
  display:flex; gap:12px; align-items:center;
}
.logo{ width:76px;height:76px;object-fit:contain; }

/* user list */
.userlist{ padding:8px 16px 110px; }

/* user card */
.usercard{
  display:flex;align-items:center;gap:12px;
  background:#fff;padding:12px;border-radius:12px;
  margin-bottom:12px;box-shadow:0 2px 6px rgba(0,0,0,0.05);
  border:1px solid #e6e6e6;position:relative;
}
.usercard.me{ border:2px solid #007bff; }
.tagyou{
  position:absolute;top:-10px;right:-10px;
  background:#007bff;color:#fff;padding:5px 10px;border-radius:20px;
  font-size:11px;font-weight:700;
}

.avatar-area{ position:relative;width:64px;height:64px; }
.avatar-wrap{ width:64px;height:64px;border-radius:50%;overflow:hidden; }
.avatar-wrap img{ width:100%;height:100%;object-fit:cover; }

.edit-foto-floating{
  position:absolute;right:-6px;bottom:-6px;
  width:30px;height:30px;border-radius:50%;
  background:#3E8BFF;color:#fff;display:flex;align-items:center;justify-content:center;
  border:2px solid #fff;font-size:14px;cursor:pointer;
}
.edit-foto-floating input{ display:none; }

.name-hand{
  font-family:'Caveat',cursive;
  font-size:18px;color:#111;display:flex;align-items:center;gap:8px;
}
.edit-ico{ font-size:15px;color:#3E8BFF;cursor:pointer; }

.uname{ font-size:13px;color:#666; }

.role-tag{
  margin-left:auto;padding:6px 10px;border-radius:10px;
  font-weight:700;font-size:12px;white-space:nowrap;
}

/* popup background */
.popup-bg{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.42);
  display:none;justify-content:center;align-items:center;
  z-index:9999;
}

/* popup preview */
.popup-box{
  background:#fff;border-radius:12px;width:86%;max-width:360px;
  padding:0;overflow:hidden;
  box-shadow:0 8px 26px rgba(0,0,0,0.16);
}
.popup-box img{ width:100%;display:block; }

/* toast */
.toast{
  position:fixed;bottom:22px;left:50%;transform:translateX(-50%);
  background:#111;color:#fff;padding:10px 16px;border-radius:999px;
  opacity:0;pointer-events:none;transition:.25s;z-index:99999;
}
.toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

/* navbar */
.navbar{
  position:fixed;bottom:0;left:0;right:0;background:#fff;
  display:flex;justify-content:space-around;padding:8px 0 6px;
  border-top:1px solid #e6e6e6;
}
.nav-item{
  display:flex;flex-direction:column;align-items:center;
  font-size:11px;font-weight:600;color:#6a6a6a;cursor:pointer;
}
.nav-item img{ width:28px;height:28px;margin-bottom:4px;opacity:.65; }
.nav-active{ background:rgba(62,139,255,0.12);color:#3E8BFF!important; }
.nav-active img{ opacity:1!important; }

/* bounce */
.bounce{ animation:bounceTap .25s ease-out; }
@keyframes bounceTap{
 0%{transform:scale(1)}40%{transform:scale(.92)}100%{transform:scale(1)}
}
</style>
</head>

<body>

<!-- INFO -->
<div class="info-card">
  <img src="/assets/logo.png" class="logo">
  <div class="info-text">
    <div style="font-weight:700">BIG Motor Tingkulu</div>
    <div style="font-size:13px;color:#666;margin-top:6px">
      Jl. Tololiu Supit, Tingkulu - Wanea<br>
      web: bigmotortingkulu.com • Katalog: bigmotor.biz.id
    </div>
  </div>
</div>

<!-- USER LIST -->
<div class="userlist" id="userlist"></div>

<!-- PREVIEW FOTO -->
<div id="previewFotoBg" class="popup-bg">
  <div class="popup-box">
    <img id="previewFotoImg" src="">
    <button onclick="uploadFotoFinal()" style="width:100%;padding:12px;background:#16a34a;color:#fff;border:0;font-weight:700;">Simpan</button>
    <button onclick="closePreviewFoto()" style="width:100%;padding:12px;background:#ef4444;color:#fff;border:0;font-weight:700;margin-top:4px;">Batal</button>
  </div>
</div>

<!-- FULL IMAGE -->
<div id="fullView" class="popup-bg" style="background:rgba(0,0,0,0.78);" onclick="closeFullImg()">
  <img id="fullImg" src="" style="max-width:92%;max-height:92%;border-radius:10px;">
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- NAVBAR -->
<div class="navbar">
  <div class="nav-item" onclick="bounceThenNavigate(this,'home.html')">
    <img src="assets/beranda.png">Beranda
  </div>
  <div class="nav-item" onclick="bounceThenNavigate(this,'barang.html')">
    <img src="assets/barang.png">Barang
  </div>
  <div class="nav-item" onclick="bounceThenNavigate(this,'riwayat.html')">
    <img src="assets/riwayat.png">Riwayat
  </div>
  <div class="nav-item nav-active" id="navPengaturan">
    <img src="assets/pengaturan.png">Pengaturan
  </div>
</div>

<script>
/* ===========================================================
   LOAD USERS
=========================================================== */
async function loadUsers(){
  try{
    const r = await fetch(API_BASE + "/api/users");
    const j = await r.json();
    renderUsers(j.users || []);
  }catch(e){
    showToast("Gagal memuat pengguna");
  }
}

function roleColor(role){
  role = (role||"").toLowerCase();
  if(role.includes("admin")) return "#e53935";
  if(role.includes("owner")) return "#8e24aa";
  if(role.includes("mekanik")) return "#1e88e5";
  if(role.includes("kasir")) return "#43a047";
  return "#666";
}

let pendingFile = null;
let pendingId = null;

/* ===========================================================
   RENDER USERS
=========================================================== */
function renderUsers(list){
  const me = localStorage.getItem("username");
  const root = $("userlist");
  root.innerHTML = "";

  list.forEach(u=>{
    const isMe = u.username === me;
    const foto = u.foto || `/assets/${u.username}.jpg`;
    const clr = roleColor(u.role);

    const div = document.createElement("div");
    div.className = "usercard" + (isMe ? " me" : "");
    div.innerHTML = `
      ${isMe ? '<div class="tagyou">YOU</div>' : ''}
      <div class="avatar-area">
        <div class="avatar-wrap">
          <img id="pfp_${u.id}" src="${foto}">
        </div>
        ${isMe ? `
          <label class="edit-foto-floating" onclick="event.stopPropagation()">
            <input type="file" accept="image/*" onchange="previewFoto(event, ${u.id})">
            ✎
          </label>` : ''}
      </div>

      <div style="flex:1">
        <div class="name-hand">
          ${u.nama || u.username}
          ${isMe ? `<span class="edit-ico" onclick="event.stopPropagation(); openOption(${u.id});">✎</span>` : ''}
        </div>
        <div class="uname">@${u.username}</div>
      </div>

      <div class="role-tag" style="color:${clr};border:1px solid ${clr}33;background:${clr}11;">
        ${u.role}
      </div>
    `;
    div.onclick = ()=> openFullImg(foto);

    root.appendChild(div);

    if(isMe) localStorage.setItem("userid", u.id);
  });
}

/* ===========================================================
   PREVIEW FOTO — BELUM UPLOAD
=========================================================== */
function previewFoto(e,id){
  const f = e.target.files[0];
  if(!f) return;

  pendingFile = f;
  pendingId = id;

  $("previewFotoImg").src = URL.createObjectURL(f);
  $("previewFotoBg").style.display = "flex";
}

function closePreviewFoto(){
  pendingFile = null;
  pendingId = null;
  $("previewFotoBg").style.display = "none";
}

/* ===========================================================
   UPLOAD FOTO — HANYA SAAT SIMPAN
=========================================================== */
async function uploadFotoFinal(){
  if(!pendingFile){
    showToast("Tidak ada foto");
    return;
  }

  const fd = new FormData();
  fd.append("file", pendingFile);
  fd.append("upload_preset", CLOUDINARY_PRESET);

  try{
    // Upload ke Cloudinary
    const up = await fetch(CLOUDINARY_UPLOAD,{method:"POST",body:fd});
    const img = await up.json();

    if(!img.secure_url){
      showToast("Upload gagal");
      return;
    }

    // Update DB
    await fetch(API_BASE + "/api/user/foto/" + pendingId, {
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ foto: img.secure_url })
    });

    showToast("Foto diperbarui");

    pendingFile = null;
    pendingId = null;

    $("previewFotoBg").style.display = "none";

    loadUsers();

  }catch(err){
    console.error(err);
    showToast("Upload gagal");
  }
}

/* ===========================================================
   FULL IMAGE
=========================================================== */
function openFullImg(url){
  $("fullImg").src = url;
  $("fullView").style.display = "flex";
}
function closeFullImg(){ $("fullView").style.display="none"; }

/* toast */
function showToast(m){
  const t = $("toast");
  t.textContent = m;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"),1700);
}

/* name, pass */
function openOption(){}

</script>

</body>
</html>