<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice</title>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
body { 
  font-family: Arial; 
  margin:0; 
  padding:16px; 
  padding-top:0;
  background:#f5f5f5; 
}

.paid-stamp {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-15deg);
  width: 140px;
  height: 140px;
  border: 6px solid rgba(0, 120, 0, 0.35);
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 26px;
  font-weight: 900;
  color: rgba(0, 120, 0, 0.35);
  text-transform: uppercase;
  letter-spacing: 2px;
  pointer-events: none;
  user-select: none;
  z-index: 5;
  box-shadow: 0 0 4px rgba(0,0,0,0.15);
}

.summary-card {
  position: sticky;
  bottom: 0;
  background: white;
  padding: 14px;
  border-radius: 12px;
  margin-top: 12px;
  box-shadow: 0 -3px 14px rgba(0,0,0,0.12);
  z-index: 20;
}

.sc-row {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
  font-size: 14px;
}

.swipe-hint {
  position: absolute;
  top: -10px;
  right: 20px;
  background: rgba(0,0,0,0.4);
  color: white;
  padding: 4px 10px;
  border-radius: 10px;
  font-size: 12px;
  opacity: 0;
  animation: hintFade 3s ease-out forwards;
  z-index: 50;
}

@keyframes hintFade {
  0% { opacity: 0; transform: translateX(20px); }
  20% { opacity: 1; transform: translateX(0); }
  80% { opacity: 1; }
  100% { opacity: 0; }
}

/* HEADER */
.header-wrap{ position:relative; }
.header{
  background:linear-gradient(90deg,#e8f0ff,#f3f7ff);
  padding:14px 16px;
  padding-right:90px;
  border-bottom:1px solid #e6eefc;
  position:sticky; top:0;
  z-index:30;
}
.header-icon{
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  width:54px;
}
.h-title{ font-size:18px; font-weight:800; }
.h-sub{ font-size:14px; font-weight:600; color:#666; margin-top:2px; }
.h-web{ font-size:13px; color:#666; margin-top:4px; }

/* STICKY NEAREST CARD */
.nearest-card{
  position:sticky;
  top:74px;
  background:white;
  padding:14px;
  border-radius:12px;
  margin-top:12px;
  box-shadow:0 3px 14px rgba(0,0,0,0.12);
  z-index:20;
}
.nc-title{ font-size:16px; font-weight:700; }
.nc-sub{ font-size:14px; color:#666; margin-bottom:10px; }
.nc-row{
  display:flex;
  justify-content:space-between;
  margin-top:6px;
  font-size:14px;
}
.nc-empty{
  font-size:14px;
  margin-top:8px;
  color:#999;
}

/* FAB ADD */
#fab-add {
  position:fixed;
  bottom:18px;
  right:18px;
  width:58px;
  height:58px;
  border-radius:50%;
  background:#4a8dff;
  color:white;
  font-size:32px;
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 4px 14px rgba(0,0,0,0.25);
  z-index:20;
}

/* POPUP */
.popup-bg { 
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:0;
  z-index:999;
}
.popup {
  background:white;
  padding:22px;
  border-radius:14px;
  width:90%;
  max-width:420px;
  box-shadow:0 6px 24px rgba(0,0,0,0.25);
  margin:auto;
}
.popup-error {
  color:#b00020;
  margin-bottom:10px;
  font-weight:bold;
  display:none;
}
.field { display:flex; flex-direction:column; margin-bottom:14px; }
.field label { font-size:14px; margin-bottom:6px; }

.input-box {
  border:1px solid #bbb;
  border-radius:8px;
  padding:12px;
  font-size:16px;
  width:100%;
  box-sizing:border-box;
}

.prefix-wrap {
  display:flex; align-items:center; border:1px solid #bbb;
  border-radius:8px; padding:0 10px; background:white; height:48px;
  box-sizing:border-box;
}
.prefix-wrap span { font-weight:bold; margin-right:6px; }
.prefix-wrap input {
  border:none;
  width:100%;
  padding:10px 0;
  outline:none;
  font-size:16px;
}

.date-clicker {
  border:1px solid #bbb;
  border-radius:8px;
  padding:12px;
  height:48px;
  display:flex;
  align-items:center;
  font-size:16px;
  background:white;
  cursor:pointer;
  position:relative;
  box-sizing:border-box;
}
.date-clicker:after {
  content:"üìÖ";
  position:absolute;
  right:12px;
  top:10px;
  font-size:18px;
  opacity:0.6;
}
.hidden-date {
  position:absolute;
  opacity:0;
  pointer-events:none;
}

/* LIST ‚Äî HORIZONTAL SCROLL */
#list{
  margin-top:14px;
  display:flex;
  gap:14px;
  overflow-x:auto;
  padding-bottom:18px;
}

/* CARD ‚Äî only height changed (reduced 100px), no other formatting changed */
.card {
  background:white;
  padding:0;
  border-radius:12px;
  box-shadow:0 4px 16px rgba(0,0,0,0.15);
  flex:0 0 82%; 
  height: calc(100vh - 510px); /* -100px */
  overflow-y:hidden; /* prevent vertical scroll */
  position:relative;
}

.card-header {
  padding:12px 16px;
  font-size:16px;
  display:flex;
  justify-content:center;   /* <= CENTER */
  align-items:center;
  color:black;               /* <= hitam */
  background:none;           /* <= tanpa background */
}

.card-header.unpaid { 
  background:#ca3433;
  color:black;
}
.card-header.paid { background:#bfc3c8; color:#333; }

.card-body { padding:16px; display:flex; flex-direction:column; gap:12px; }
.row-flex { display:flex; justify-content:space-between; align-items:center; gap:12px; }
.label { font-size:14px; color:#555; }
.value { font-size:16px; font-weight:bold; }

.status-box {
  padding:8px 14px;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  white-space:nowrap;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  position:absolute;
  right:16px;
  bottom:16px;
}
.status-unpaid { background:#ffe1e1; color:#8a0000; }
.status-paid   { background:#d6e6ff; color:#004b9a; cursor:default; }

.card-footer {
  background:#f7f7f7;
  padding:10px 16px;
  font-size:14px;
  font-style:italic;
  text-align:center;
}

/* BUTTONS */
.btn-save {
  background:#4a8dff;
  color:white;
  border:none;
  padding:10px 18px;
  border-radius:8px;
  box-shadow:0 3px 8px rgba(0,0,0,0.2);
}
.btn-close {
  background:#ff7070;
  color:white;
  border:none;
  padding:10px 18px;
  border-radius:8px;
  box-shadow:0 3px 8px rgba(0,0,0,0.2);
}

/* FAB BACK */
.fab-back{
  position:fixed;
  left:18px;
  bottom:18px;
  width:58px;
  height:58px;
  border-radius:50%;
  background:#ffffff;
  box-shadow:0 4px 18px rgba(0,0,0,0.22);
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  z-index:9999;
}
.fab-back img{
  width:32px;
  height:32px;
  object-fit:contain;
}
.sc-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 8px;
}
  </style>
</head>

<body>

  <div class="header-wrap">
    <div class="header">
      <div class="h-title">List Invoice</div>
      <div class="h-web">BIG Motor Tingkulu</div>
      <div class="h-sub" id="headerTime"></div>
      <img src="assets/bill.png" class="header-icon">
    </div>
  </div>

  <!-- STICKY NEAREST CARD -->
  <div id="nearestCard" class="nearest-card">
    <div class="nc-title">‚ö†Ô∏è Tagihan terdekat</div>
    <div class="nc-sub">(Dalam <span id="nc-days">-</span> hari)</div>

    <div id="nc-content">
      <div class="nc-row">
        <span>Tanggal Jatuh Tempo:</span>
        <strong id="nc-date">-</strong>
      </div>
      <div class="nc-row">
        <span>Nominal:</span>
        <strong id="nc-nominal">-</strong>
      </div>
      <div class="nc-row">
        <span>Keterangan:</span>
        <strong id="nc-ket">-</strong>
      </div>
    </div>

    <div id="nc-empty" class="nc-empty" style="display:none;">
      Tidak ada tagihan terdekat.
    </div>
  </div>

  <button id="fab-add">+</button>

<div id="summaryCard" class="summary-card">
    <div class="sc-title">‚ÄºÔ∏è Outstanding & Overdue</div>
  <div class="sc-row">
    <span>Total Outstanding:</span>
    <strong id="sc-outstanding">-</strong>
  </div>
  <div class="sc-row">
    <span>Total Dibayar:</span>
    <strong id="sc-paid">-</strong>
  </div>
  <div class="sc-row">
    <span>Total Overdue:</span>
    <strong id="sc-overdue">-</strong>
  </div>
  <div class="sc-row">
    <span>Overdue:</span>
    <strong id="sc-overdue-days">-</strong>
  </div>
</div>

<div style="position:relative;">
  <div id="swipeHint" class="swipe-hint">&lt;&lt; geser</div>
  <div id="list"></div>
</div>

  <div id="list"></div>

  <!-- POPUP INPUT -->
  <div id="popup-bg" class="popup-bg">
    <div class="popup">
      <h3 style="margin-bottom:18px;">Input Invoice</h3>

      <div id="popup-error" class="popup-error"></div>

      <div class="field">
        <label>Tanggal Invoice</label>
        <div id="tgl_invoice_click" class="date-clicker"></div>
        <input type="date" id="tanggal_invoice" class="hidden-date">
      </div>

      <div class="field">
        <label>Nilai Invoice</label>
        <div class="prefix-wrap">
          <span>Rp</span>
          <input type="text" id="nilai_invoice" placeholder="0"
            autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
        </div>
      </div>

      <div class="field">
        <label>Keterangan</label>
        <textarea id="keterangan" class="input-box" placeholder="Keterangan"></textarea>
      </div>

      <div class="field">
        <label>Tanggal Jatuh Tempo</label>
        <div id="tgl_tempo_click" class="date-clicker"></div>
        <input type="date" id="tanggal_jatuh_tempo" class="hidden-date">
      </div>

      <button class="btn-save" id="btn-save">Simpan</button>
      <button class="btn-close" id="btn-close" style="margin-left:6px;">Tutup</button>
    </div>
  </div>
  

<script>
const API = "https://msg.wendyrenzya.workers.dev/api";

const popupBg = document.getElementById("popup-bg");
const popupError = document.getElementById("popup-error");

const tglInvHidden = document.getElementById("tanggal_invoice");
const tglInvClick  = document.getElementById("tgl_invoice_click");

const tglTempoHidden = document.getElementById("tanggal_jatuh_tempo");
const tglTempoClick  = document.getElementById("tgl_tempo_click");

const list = document.getElementById("list");

popupBg.style.display = "none";

document.getElementById("fab-add").onclick = () => popupBg.style.display = "flex";
document.getElementById("btn-close").onclick = () => popupBg.style.display = "none";

const monthShort = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];

function formatTanggalDisplay(ymd){
  if(!ymd) return "";
  const [y,m,d] = ymd.split("-");
  return `${d} ${monthShort[Number(m)-1]} ${y.slice(2)}`;
}

function addOneMonth(ymd){
  const [y,m,d] = ymd.split("-");
  let newM = Number(m) + 1;
  let newY = Number(y);
  if(newM > 12){ newM = 1; newY++; }
  return `${newY}-${String(newM).padStart(2,"0")}-${d}`;
}

function setDefaults(){
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,"0");
  const dd = String(now.getDate()).padStart(2,"0");

  const today = `${yyyy}-${mm}-${dd}`;

  tglInvHidden.value = today;
  tglInvClick.textContent = formatTanggalDisplay(today);

  const nextMonth = addOneMonth(today);
  tglTempoHidden.value = nextMonth;
  tglTempoClick.textContent = formatTanggalDisplay(nextMonth);
}
setDefaults();

tglInvClick.onclick = () => tglInvHidden.showPicker();
tglInvHidden.onchange = () => {
  const newDate = tglInvHidden.value;
  tglInvClick.textContent = formatTanggalDisplay(newDate);

  const newTempo = addOneMonth(newDate);
  tglTempoHidden.value = newTempo;
  tglTempoClick.textContent = formatTanggalDisplay(newTempo);
};

tglTempoClick.onclick = () => tglTempoHidden.showPicker();
tglTempoHidden.onchange = () =>
  tglTempoClick.textContent = formatTanggalDisplay(tglTempoHidden.value);

function formatRupiahInput(v){
  v = v.replace(/[^0-9]/g,"");
  return v.replace(/\B(?=(\d{3})+(?!\d))/g,".");
}

document.getElementById("nilai_invoice").addEventListener("input", e=>{
  e.target.value = formatRupiahInput(e.target.value);
});

function parseRupiah(s){ return Number((s||"").replace(/\./g,"")) || 0; }

document.getElementById("btn-save").onclick = saveInvoice;

async function saveInvoice(){
  popupError.style.display = "none";

  const tanggal = tglInvHidden.value;
  const nilai = parseRupiah(document.getElementById("nilai_invoice").value);
  const ket = document.getElementById("keterangan").value;
  const tempo = tglTempoHidden.value;

  if(!tanggal || !nilai || !ket || !tempo){
    popupError.textContent = "Semua field wajib diisi.";
    popupError.style.display = "block";
    return;
  }

  const body = {
    tanggal_invoice: tanggal,
    nilai_invoice: nilai,
    keterangan: ket,
    tanggal_jatuh_tempo: tempo
  };

  try{
    await axios.post(`${API}/invoice/create`, body);
    popupBg.style.display = "none";
    loadList();
  }catch(e){
    popupError.textContent = e.response?.data?.error || e.message;
    popupError.style.display = "block";
  }
}

async function loadList(){
  try{
    const r = await axios.get(`${API}/invoice/list`);
    const items = r.data.items || [];
    setNearest(items);
setSummary(items);   // <‚Äî WAJIB, ini yang hilang
renderList(items);
// tampilkan animasi swipe hint hanya saat load pertama
if (!window._swipeShown) {
  const h = document.getElementById("swipeHint");
  h.style.opacity = "1";
  h.style.animation = "hintFade 3s ease-out forwards";
  window._swipeShown = true;
}
  }catch(e){
    list.innerHTML = "Gagal mengambil data.";
  }
}

/* SET NEAREST */
function setNearest(items){
  const ncDays = document.getElementById("nc-days");
  const ncDate = document.getElementById("nc-date");
  const ncNom = document.getElementById("nc-nominal");
  const ncKet = document.getElementById("nc-ket");
  const ncContent = document.getElementById("nc-content");
  const ncEmpty = document.getElementById("nc-empty");

  if(!items.length){
    ncContent.style.display="none";
    ncEmpty.style.display="block";
    ncDays.textContent="-";
    return;
  }

  const today = new Date();

  let nearest = null;
  let nearestDiff = Infinity;

  items.forEach(v=>{
    const dt = new Date(v.tanggal_jatuh_tempo);
    const diff = Math.ceil((dt - today) / 86400000);
    if(diff >= 0 && diff < nearestDiff){
      nearestDiff = diff;
      nearest = v;
    }
  });

  if(!nearest){
    ncContent.style.display="none";
    ncEmpty.style.display="block";
    ncDays.textContent="-";
    return;
  }

  ncContent.style.display="block";
  ncEmpty.style.display="none";

  ncDays.textContent = nearestDiff;
  ncDate.textContent = formatTanggalDisplay(nearest.tanggal_jatuh_tempo);
  ncNom.textContent = "Rp " + Number(nearest.nilai_invoice).toLocaleString("id-ID");
  ncKet.textContent = nearest.keterangan;
}
function setSummary(items){
  const outEl = document.getElementById("sc-outstanding");
  const paidEl = document.getElementById("sc-paid");
  const odEl = document.getElementById("sc-overdue");
  const odDaysEl = document.getElementById("sc-overdue-days");

  let totalOutstanding = 0;
  let totalPaid = 0;
  let overdueCount = 0;
  let maxOverdueDays = 0;

  const today = new Date();

  items.forEach(v=>{
    const nilai = Number(v.nilai_invoice) || 0;
    const due = new Date(v.tanggal_jatuh_tempo);

    if(v.status === "unpaid"){
      totalOutstanding += nilai;

      const diffDays = Math.ceil((today - due) / 86400000);
      if(diffDays > 0){
        overdueCount++;
        if(diffDays > maxOverdueDays) maxOverdueDays = diffDays;
      }
    }
    else if(v.status === "paid"){
      totalPaid += nilai;
    }
  });

  outEl.textContent = "Rp " + totalOutstanding.toLocaleString("id-ID");
  paidEl.textContent = "Rp " + totalPaid.toLocaleString("id-ID");
  // total overdue
odEl.textContent = overdueCount;

// overdue days
if (overdueCount === 0) {
  odDaysEl.textContent = "Tidak ada overdue";
  odDaysEl.style.color = "#3b6cff";   // biru tipis
  odDaysEl.style.fontStyle = "italic";
} else {
  odDaysEl.textContent = `${maxOverdueDays} hari`;
  odDaysEl.style.color = "";   // reset jika sebelumnya biru
  odDaysEl.style.fontStyle = "";
}
}

/* RENDER LIST ‚Äî header retains nominal on left; due moved into body */
function renderList(items){
  list.innerHTML = "";

  if(!items.length){
    list.innerHTML = `<div style="margin-top:14px;">Tidak ada invoice.</div>`;
    return;
  }

  const today = new Date();

  // === SORTING SESUAI URUTAN YANG DIMINTA ===
  // 1. unpaid paling dekat jatuh tempo
  // 2. unpaid lainnya
  // 3. paid
  const sorted = [...items].sort((a,b)=>{
    if(a.status === "unpaid" && b.status === "unpaid"){
      const da = new Date(a.tanggal_jatuh_tempo);
      const db = new Date(b.tanggal_jatuh_tempo);
      return da - db; // yang paling dekat jatuh tempo dulu
    }

    if(a.status === "unpaid") return -1; // unpaid dulu
    if(b.status === "unpaid") return 1;

    return 0; // paid tetap di belakang
  });
  sorted.forEach(inv=>{
    const card = document.createElement("div");
    card.className = "card";

if (inv.status === "paid") {
  const stamp = document.createElement("div");
  stamp.className = "paid-stamp";
  stamp.textContent = "LUNAS";
  card.appendChild(stamp);
}

    // preserve header element and place Nilai: Rp ... on the left
    const header = document.createElement("div");
    header.className = "card-header " + (inv.status === "unpaid" ? "unpaid" : "paid");
    header.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px;">
        <div style="font-weight:700; font-size:16px;">Jumlah Tagihan: Rp ${Number(inv.nilai_invoice).toLocaleString("id-ID")}</div>
      </div>
    `;
    card.appendChild(header);

    const body = document.createElement("div");
    body.className = "card-body";

    // JATUH TEMPO (moved into body, red)
    const due = document.createElement("div");
    due.className = "card-due";
    due.innerHTML = 
  inv.status === "paid"
    ? `<span style="color:#888; text-decoration:line-through;">Jatuh Tempo: ${formatTanggalDisplay(inv.tanggal_jatuh_tempo)}</span>`
    : `Jatuh Tempo: ${formatTanggalDisplay(inv.tanggal_jatuh_tempo)}`;
    due.style.color = "#b00000";
    body.appendChild(due);

    // KETERANGAN (keep original label/value structure)
    const row = document.createElement("div");
    row.className = "row-flex";
    row.innerHTML = `
      <div>
        <span class="label">Keterangan</span><br>
        <span class="value" style="white-space:pre-line;">${inv.keterangan}</span>
      </div>
    `;
    body.appendChild(row);

    // move footer text into body (preserve visual style)
    const footerInline = document.createElement("div");
    footerInline.className = "card-footer";
    footerInline.style.marginTop = "6px";
    footerInline.textContent = "Tanggal Invoice: " + formatTanggalDisplay(inv.tanggal_invoice);
    body.appendChild(footerInline);

    card.appendChild(body);

    // status at bottom-right
    const statusBtn = document.createElement("div");
    statusBtn.className = inv.status === "unpaid" ? "status-box status-unpaid" : "status-box status-paid";
    statusBtn.textContent = inv.status === "unpaid" ? "Belum Dibayar" : "Lunas";

    if(inv.status === "unpaid"){
      statusBtn.onclick = async()=>{
        try{
          await axios.post(`${API}/invoice/update-status/${inv.id}`);
          loadList();
        }catch(_){}
      };
    }

    card.appendChild(statusBtn);

    list.appendChild(card);
  });
}

loadList();

/* HEADER CLOCK */
function updateHeaderTime(){
  const d = new Date();
  const hari = ["Min","Sen","Sel","Rab","Kam","Jum","Sab"][d.getDay()];
  const bln = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"][d.getMonth()];
  const tgl = d.getDate().toString().padStart(2,"0");
  const thn = d.getFullYear();
  const jam = d.getHours().toString().padStart(2,"0");
  const mnt = d.getMinutes().toString().padStart(2,"0");

  document.getElementById("headerTime").textContent =
    `${hari}, ${tgl} ${bln} ${thn}, ${jam}:${mnt}`;
}
setInterval(updateHeaderTime,1000);
updateHeaderTime();
</script>

<div class="fab-back" id="fabBack">
  <img src="assets/back_white.png">
</div>

<script>
document.getElementById("fabBack").onclick = () => history.back();
</script>

</body>
</html>
