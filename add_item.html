<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tambah Barang ke Servis</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f6f8fb;--card:#fff;--muted:#6b7280;
  --primary:#1976f7;--accent:#3E8BFF;
  --success:#2ecc71;--danger:#ff3b30;
  --radius:14px;--shadow:0 8px 20px rgba(0,0,0,.07);
}
*{
  box-sizing:border-box;margin:0;padding:0;
  font-family:Inter,-apple-system,system-ui;
  -webkit-tap-highlight-color: transparent;
}
body{background:var(--bg);padding:14px;color:#111}

.header{
  background:linear-gradient(90deg,#e8f0ff,#f3f7ff);
  padding:14px 16px;text-align:center;
  border-bottom:1px solid #e6eefc;margin-bottom:16px;
}
.h-title{font-size:18px;font-weight:800;}
.h-sub{font-size:14px;font-weight:600;color:#666;margin-top:2px;}

.popup{
  display:block;
}
.popup-inner{
  background:#fff;width:100%;border-radius:14px;
  padding:0;max-height:88vh;overflow:auto;position:relative;
  box-shadow:0 8px 22px rgba(0,0,0,.08)
}
.popup-header{
  position:sticky;top:0;z-index:12;background:#fff;
  display:flex;align-items:center;gap:8px;
  padding:12px;border-bottom:1px solid #eee;
}
.search-input{
  flex:1;padding:10px;border-radius:10px;
  border:1px solid #dcdcdc;font-size:15px;
}
.close-top{
  border:0;background:#fff;border-radius:8px;
  padding:8px 10px;cursor:pointer;
  box-shadow:0 6px 12px rgba(0,0,0,.06)
}
.popup-content{padding:14px}

.hl{color:var(--primary);font-weight:700}

/* Card barang */
.prod-card{
  background:#fff;border-radius:14px;border:1px solid #e5e5e5;
  margin-bottom:12px;box-shadow:var(--shadow);overflow:hidden;
  transition:.15s;
}
.card-header{
  font-weight:800;font-size:15px;padding:10px 14px;background:#f9fafc;
  border-bottom:1px solid #e6e6e6;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}
.card-body{
  padding:12px;display:grid;grid-template-columns:auto 1fr auto;
  gap:8px;align-items:center;position:relative
}
.thumb{
  width:60px;height:50px;border-radius:10px;background:#eee;
  background-size:cover;background-position:center
}

.qty-wrap{display:none;align-items:center;gap:6px}
.qty-circle{
  width:28px;height:28px;border-radius:999px;border:1px solid #ccc;
  background:#fff;display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:16px;cursor:pointer;
}
.qty-num{min-width:28px;text-align:center;font-weight:800;font-size:15px}

.right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.price-line{display:flex;align-items:center;gap:6px}
.price-text{font-weight:800;font-size:15px}
.pencil{
  padding:6px 8px;font-size:14px;cursor:pointer;border-radius:8px;
  background:#f3f7ff;border:1px solid #e6eefc;
}
.total-row{
  margin-top:12px;padding:10px 12px;background:#f8fbff;
  border-top:1px solid #e3e8ef;display:none;
  align-items:center;grid-column:1 / span 3;justify-content:space-between
}
.total-left{display:flex;align-items:center;gap:8px}
.ok-btn{
  padding:8px 16px;border-radius:999px;background:var(--success);
  color:#fff;font-weight:800;border:0;cursor:pointer;
}
.total-label{font-weight:800;color:var(--primary)}

/* BOTTOM SHEET */
.bottom-sheet{
  position:fixed;left:0;right:0;bottom:-220px;
  background:#fff;border-radius:16px 16px 0 0;
  padding:20px;box-shadow:0 -6px 20px rgba(0,0,0,.15);
  transition:.3s;z-index:15000
}
.bottom-sheet.show{bottom:0}
.sheet-btn{
  padding:12px 18px;border-radius:999px;border:0;
  font-weight:800;cursor:pointer
}
.sheet-btn.cancel{background:#fff;border:1px solid #ddd}
.sheet-btn.ok{background:var(--success);color:#fff;margin-left:auto}

.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:22px;background:#111;color:#fff;
  padding:10px 14px;border-radius:999px;
  opacity:0;pointer-events:none;
  transition:opacity .25s,transform .25s;
  z-index:26000
}
.toast.show{
  opacity:1;transform:translateX(-50%) translateY(-6px)
}

/* EDIT HARGA */
.edit-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.36);display:none;
  align-items:center;justify-content:center;z-index:20000;
}
.edit-box{
  background:#fff;padding:14px;border-radius:12px;min-width:300px;
  box-shadow:0 12px 30px rgba(0,0,0,.12);
}
.edit-input{
  width:100%;padding:10px;border-radius:12px;border:1px solid #ddd;
  font-size:15px;margin-bottom:12px;
}
</style>
</head>

<body>
<script>
  const token = localStorage.getItem("token");
  if (!token) location.href = "index.html";
</script>

<div class="header">
  <div class="h-title">Tambah Barang</div>
  <div class="h-sub">Pilih barang untuk ditambahkan</div>
</div>

<!-- LIST BARANG -->
<div class="popup">
  <div class="popup-inner">
    <div class="popup-header">
      <input id="search" class="search-input" placeholder="Cari barang..."
        autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <button onclick="goBack()" class="close-top">✕</button>
    </div>
    <div class="popup-content">
      <div id="list"></div>
    </div>
  </div>
</div>

<!-- EDIT HARGA -->
<div id="editOverlay" class="edit-overlay">
  <div class="edit-box">
    <h4 style="margin-bottom:8px">Edit Harga</h4>
    <input id="editPriceInput" class="edit-input" inputmode="numeric">
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="editCancel" class="sheet-btn cancel">Batal</button>
      <button id="editSave" class="sheet-btn ok">Simpan</button>
    </div>
  </div>
</div>

<!-- BOTTOM SHEET -->
<div id="sheet" class="bottom-sheet">
  <div class="bottom-sheet-title">✔ <span id="sheetCount"></span> barang dipilih</div>
  <div class="bottom-sheet-sub">Total = <span id="sheetTotal"></span></div>
  <div style="display:flex;gap:10px">
    <button id="sheetCancel" class="sheet-btn cancel">Batal</button>
    <button id="sheetOk" class="sheet-btn ok">OK</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const API_BASE = "https://api.bigmotor.biz.id";
const $ = id => document.getElementById(id);

// Ambil ID servis dari query
const ID = Number(new URLSearchParams(location.search).get("id"));

let ITEMS = [];
let CART = {};
let openCard = null;
let defaultPrices = {};
let editingContext = null;

/* ===========================
   UTILITIES
=========================== */
function currency(n){return "Rp "+Number(n||0).toLocaleString("id-ID")}

function toast(t){
  const el = $("toast");
  el.textContent = t;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"),1800);
}

/* ===========================
   LOAD BARANG
=========================== */
async function loadItems(){
  const r = await fetch(API_BASE+"/api/barang");
  const j = await r.json();
  ITEMS = j.items || [];
  defaultPrices = {};
  ITEMS.forEach(b => defaultPrices[b.id] = b.harga);
}

/* ===========================
   FUZZY SEARCH
=========================== */
function fuzzyScoreAndHighlight(name,q){
  if(!q) return {score:1, html:name};
  const nl=name.toLowerCase(), ql=q.toLowerCase();
  if(nl.includes(ql)){
    const i = nl.indexOf(ql);
    return {
      score:1,
      html: name.slice(0,i) +
            `<span class="hl">${name.slice(i,i+ql.length)}</span>` +
            name.slice(i+ql.length)
    };
  }
  return {score:0, html:name};
}

/* ===========================
   RENDER LIST
=========================== */
function renderList(q=""){
  const wrap = $("list");
  wrap.innerHTML = "";

  let arr = ITEMS.slice();
  if(q.trim()){
    arr = arr.map(b=>{
      const {score,html} = fuzzyScoreAndHighlight(b.nama||"",q.trim());
      return {...b,_score:score,_html:html};
    }).filter(x=>x._score>0);
  }

  if(!arr.length){
    wrap.innerHTML = `<div style="padding:20px;text-align:center;color:#777">Tidak ada barang</div>`;
    return;
  }

  arr.forEach(b=>{
    const card = document.createElement("div");
    card.className = "prod-card";
    card.dataset.id = b.id;

    card.innerHTML = `
      <div class="card-header">${b._html || b.nama}</div>
      <div class="card-body">
        <div class="thumb" style="background-image:url('${b.foto||""}')"></div>

        <div class="qty-wrap">
          <div class="qty-circle minus">−</div>
          <div class="qty-num">1</div>
          <div class="qty-circle plus">+</div>
        </div>

        <div class="right">
          <div class="price-line">
            <div class="price-text">${currency(b.harga)}</div>
            <div class="pencil">✎</div>
          </div>
        </div>

        <div class="total-row">
          <div class="total-left"><button class="ok-btn">OK</button></div>
          <div class="total-label">TOTAL: ${currency(b.harga)}</div>
        </div>
      </div>
    `;

    const qtyWrap = card.querySelector(".qty-wrap");
    const minus   = card.querySelector(".minus");
    const plus    = card.querySelector(".plus");
    const qtyNum  = card.querySelector(".qty-num");
    const pencil  = card.querySelector(".pencil");
    const priceText = card.querySelector(".price-text");
    const totalRow  = card.querySelector(".total-row");
    const totalLabel= card.querySelector(".total-label");
    const okBtn = card.querySelector(".ok-btn");

    // open/close card
    card.onclick = e=>{
      if(e.target.closest(".qty-circle") ||
         e.target.closest(".pencil") ||
         e.target.closest(".ok-btn")) return;
      toggleCard(card,b);
    };

    minus.onclick = e=>{
      e.stopPropagation();
      let c = Number(qtyNum.textContent)||1;
      c = Math.max(1, c-1);
      qtyNum.textContent = c;
      totalLabel.textContent = "TOTAL: "+currency(c*b.harga);
    };

    plus.onclick = e=>{
      e.stopPropagation();
      let c = Number(qtyNum.textContent)||1;
      c++;
      qtyNum.textContent = c;
      totalLabel.textContent = "TOTAL: "+currency(c*b.harga);
    };

    // edit harga
    pencil.onclick = e=>{
      e.stopPropagation();
      openEditDialog(b,priceText,totalLabel,qtyNum);
    };

    // OK select
    okBtn.onclick = e=>{
      e.stopPropagation();
      const qty = Number(qtyNum.textContent)||1;
      CART[b.id] = {
        id: b.id,
        qty,
        harga: b.harga,
        nama: b.nama,
        subtotal: qty*b.harga,
        keterangan:""
      };

      card.classList.remove("open");
      qtyWrap.style.display = "none";
      totalRow.style.display = "none";
      pencil.classList.remove("show");

      showSheet();
    };

    wrap.appendChild(card);
  });
}

function toggleCard(card,b){
  if(openCard && openCard!==card){
    closeCardUI(openCard,true);
  }

  const open = card.classList.contains("open");
  if(open){
    closeCardUI(card,true);
    openCard = null;
  } else {
    openCard = card;
    card.classList.add("open");

    const qtyWrap = card.querySelector(".qty-wrap");
    const totalRow = card.querySelector(".total-row");
    const qtyNum = card.querySelector(".qty-num");
    const pencil = card.querySelector(".pencil");

    qtyWrap.style.display="flex";
    totalRow.style.display="flex";
    setTimeout(()=>pencil.classList.add("show"),40);

    totalRow.querySelector(".total-label").textContent =
      "TOTAL: "+currency((Number(qtyNum.textContent)||1)*b.harga);
  }
}

function closeCardUI(card,restorePrice){
  card.classList.remove("open");
  card.querySelector(".qty-wrap").style.display="none";
  card.querySelector(".total-row").style.display="none";
  card.querySelector(".pencil").classList.remove("show");

  if(restorePrice){
    const id = card.dataset.id;
    const b = ITEMS.find(x=>x.id==id);
    if(b){
      b.harga = defaultPrices[b.id];
      card.querySelector(".price-text").textContent = currency(b.harga);
    }
  }
}

/* EDIT HARGA */
function openEditDialog(b,priceText,totalLabel,qtyNum){
  editingContext = { b,priceText,totalLabel,qtyNum };
  $("editPriceInput").value = b.harga;
  $("editOverlay").style.display="flex";
  setTimeout(()=>$("editPriceInput").focus(),30);
}
$("editCancel").onclick=()=>{
  $("editOverlay").style.display="none";
  editingContext=null;
};
$("editSave").onclick=()=>{
  if(!editingContext)return;
  const v = Number($("editPriceInput").value)||0;
  const {b,priceText,totalLabel,qtyNum} = editingContext;
  b.harga = v;
  priceText.textContent = currency(v);
  const q = Number(qtyNum.textContent)||1;
  totalLabel.textContent = "TOTAL: "+currency(q*v);
  $("editOverlay").style.display="none";
  editingContext=null;
};

/* BOTTOM SHEET */
function showSheet(){
  const sheet = $("sheet");
  const keys = Object.keys(CART);
  if(!keys.length) return;

  let total = 0;
  keys.forEach(k=> total+=CART[k].subtotal);

  $("sheetCount").textContent = keys.length;
  $("sheetTotal").textContent = currency(total);

  sheet.classList.add("show");
}

$("sheetCancel").onclick = ()=>{
  CART = {};
  $("sheet").classList.remove("show");
};

$("sheetOk").onclick = async ()=>{
  $("sheet").classList.remove("show");

  // LOAD SERVIS LAMA
  const r = await fetch(API_BASE+"/api/servis/"+ID);
  const j = await r.json();
  const old = j.item || null;

  if(!old){
    toast("Servis tidak ditemukan");
    return;
  }

  const oldItems = Array.isArray(old.items)? old.items : [];

  // MERGE ITEMS
  const merged = [...oldItems];

  Object.keys(CART).forEach(id=>{
    merged.push({
      id: CART[id].id,
      qty: CART[id].qty,
      harga: CART[id].harga,
      keterangan:""
    });
  });

  // SAVE VIA UPDATE_ITEMS
  try{
    const res = await fetch(API_BASE+"/api/servis/update_items/"+ID, {
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ items: merged })
    });

    const jj = await res.json();
    if(res.ok){
      toast("Barang ditambahkan");
      setTimeout(()=>location.href="servis_detail.html?id="+ID,700);
    } else {
      toast("Gagal menyimpan");
    }
  }catch(e){
    toast("Gagal menyimpan");
  }
};

function goBack(){
  history.back();
}

/* INIT */
(async()=>{
  await loadItems();
  renderList();
})();
$("search").oninput = e=> renderList(e.target.value);
</script>

</body>
</html>